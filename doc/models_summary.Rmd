---
title: eye-tracking models
author: jw
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r cod1, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE}

here::i_am("doc/models_summary.Rmd")

library(here)
library(tibble)
library(knitr)
library(dplyr)
library(purrr)
library(readr)
library(fs)

source(here("src/models_summary.R"))
source(here("src/models.R"))

dfs <- list.files(here("results"), pattern = "region[0-9].csv") %>%
  map(~ read_csv(here("results", .)))

opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
               results = "asis", fig.path = here("figs/"), cache = TRUE)
options(digits = 5)
  ## "[a-z]+_(full)|(split)_[a-z_86]+.csv"
res <- dir_ls(here("results"), regexp = "[a-z]{2,}_((split)|(full))") %>%
  map_dfr(read_csv, .id = "source") %>%
  mutate(source = path_file(source))
```

> â€˜The professor has [a/no] [son/daughter]. The past few years, [he/she] unfortunately had to work during all the holidays.

there are 8 means in the experiment (quantifier, subject, object conditions):

| quantifier | subject (typicality) | object (interference) | alternative       | stimuli                      |
|:----------:|:--------------------:|:---------------------:|:-----------------:|:----------------------------:|
| EEN        | MATCH                | MATCH                 | (typical, int)    | prof ... a son ... he        |
| EEN        | MATCH                | MIS                   | (typical, noint)  | prof ... a daughter ... he   |
| EEN        | MIS                  | MATCH                 | (atypical, int)   | prof ... a daughter ... she  |
| EEN        | MIS                  | MIS                   | (atypical, noint) | prof ... a son ... she       |
| GEEN       | MATCH                | MATCH                 | (typical, int)    | prof ... no son ... he       |
| GEEN       | MATCH                | MIS                   | (typical, noint)  | prof ... no daughter ... he  |
| GEEN       | MIS                  | MATCH                 | (atypical, int)   | prof ... no daughter ... she |
| GEEN       | MIS                  | MIS                   | (atypical, noint) | prof ... no son ... she      |

Contrasts:

```{r coding, eval = FALSE, include = TRUE, echo = TRUE, results = "markup"}

mutate(
    cond = case_when(
      quan_cond == "EEN" & subj_cond == "MATCH" & obj_cond == "MATCH" ~ "a",
      quan_cond == "EEN" & subj_cond == "MATCH" & obj_cond == "MIS" ~ "b",
      quan_cond == "EEN" & subj_cond == "MIS" & obj_cond == "MATCH" ~ "c",
      quan_cond == "EEN" & subj_cond == "MIS" & obj_cond == "MIS" ~ "d",
      quan_cond == "GEEN" & subj_cond == "MATCH" & obj_cond == "MATCH" ~ "e",
      quan_cond == "GEEN" & subj_cond == "MATCH" & obj_cond == "MIS" ~ "f",
      quan_cond == "GEEN" & subj_cond == "MIS" & obj_cond == "MATCH" ~ "g",
      quan_cond == "GEEN" & subj_cond == "MIS" & obj_cond == "MIS" ~ "h"
    ),
    quants = ifelse(quan_cond == "EEN", -1, 1),
    typic = ifelse(cond %in% c("a", "b", "e", "f"), 1, -1), # subj match: 1, mismatch -1
    interf = ifelse(cond %in% c("a", "c", "e", "g"), 1, -1), # obj match: 1, mismatch -1
```

```{r contrasts-table }
dfs[[1]] %>%
  group_by(quan_cond, typic_cond, interf_cond) %>%
  summarise(quants_contrast = first(quants),
            subj_contrast = first(typic),
            obj_contrast = first(interf)) %>%
  mutate("quant x subj" = quants_contrast * subj_contrast,
         "quant x obj" = quants_contrast * obj_contrast,
         "subj x obj" = subj_contrast * obj_contrast,
         "quant x subj x obj" = quants_contrast * subj_contrast * obj_contrast,
         ## subj
         typic_cond = if_else(typic_cond == "atypical",
                              "mis", "match"),
         ## obj
         interf_cond = if_else(interf_cond == "interf",
                               "match", "mis"),
         "condition (quant, subj, obj)" = paste(casefold(quan_cond),
                                                typic_cond, interf_cond,
                                                sep = ", ")) %>%
  relocate("condition (quant, subj, obj)") %>%
  ungroup() %>%
  select(-c(quan_cond:interf_cond)) %>%
  rename(quantifier = quants_contrast, subject = subj_contrast,
         object = obj_contrast) %>%
  ## this is to generate the latex table
  ## select(starts_with("condition"):object) %>%
  ## kable(format = "latex")
  kable()
```

All regions as coded in the file. On the plots the thick line signifies the 0.95 probability interval, the thin line probability of 1.
Note that the region numbers are a bit misleading. Consult the table below:

| Number in the dataset | Description                                  | How it should be used in the paper               |
|:---------------------:|:--------------------------------------------:|:------------------------------------------------:|
| 1                     | subject                                      | 1                                                |
| 2                     | verb                                         | 2                                                |
| 3                     | object                                       | 3                                                |
| 4                     | wrap-up of first sentence                    | (not  present in   all  stimuli,  not  analyzed) |
| 5                     | introduction         of  second     sentence | 4                                                |
| 6                     | verb                                         | 5                                                |
| 7                     | pronoun                                      | 5                                                |
| 8                     | 3 words  spillover                           | 6                                                |
| 9                     | wrap-up of  second  sentence                 | 7                                                |

## Total fixation duration

Total fixations, all regions.

Full models.

```{r tot }
res %>%
  filter(source == "totfixdur_full_models.csv") %>%
  select(-source, -quant) %>%
  kable()
```

```{r pps1, results = "markup" }
post_plots("totfixdur", dfs, .return = "full_models")
post_plots("totfixdur", dfs, make_plot_func = pp_check, .return = "full_models")
```

### Split models

Models on data split per quantifier.

```{r tot2 }
res %>%
  filter(source == "totfixdur_split_models.csv") %>%
  select(-source) %>%
  kable()
```

```{r pps2, results = "markup" }
post_plots("totfixdur", dfs, .return = "split_models")
## post_plots("totfixdur", dfs, make_plot_func = pp_check)$split_models
```

### Further split models

Split by both quantifier and subj

```{r tot_split }
res %>%
  filter(source == "totfixdur_split_quant_typic_r8.csv") %>%
  select(-source) %>%
  mutate(condition = case_when(
           condition == "EEN_atypical" ~ "een subj mis",
           condition == "EEN_typical" ~ "een subj match",
           condition == "GEEN_typical" ~ "geen subj match",
           condition == "GEEN_atypical" ~ "geen subj mis"),
         region = "region_8") %>%
  kable()
```

```{r plots_tot_split, results = "markup" }

fit_split(dfs[7], "totfixdur",
          split_by = "quant_typic",
          .priors = priors
          ) %>%
  .[[1]] %>%
  list_rename("een subj mis" = "EEN_atypical",
              "een subj match" = "EEN_typical",
              "geen subj match" = "GEEN_typical",
              "geen subj mis" = "GEEN_atypical") %>%
  map(make_plot)
```

## Re-reading duration

Data was excluded when the subj did not re-read the region.

Full models.

```{r rrdur }
res %>%
  filter(source == "rrdur_full_models.csv") %>%
  select(-source, -quant) %>%
  kable()
```

```{r pps_rrdur, results = "markup" }
post_plots("rrdur", dfs, .return = "full_models")
post_plots("rrdur", dfs, make_plot_func = pp_check, .return = "full_models")
```

### Split models

Models on data split per quantifier.

```{r rrdur2 }
res %>%
  filter(source == "rrdur_split_models.csv") %>%
  select(-source) %>%
  kable()
```


```{r pps_rrdur2, results = "markup" }
post_plots("rrdur", dfs, .return = "split_models")
post_plots("rrdur", dfs, make_plot_func = pp_check, .return = "split_models")
```

### Further split models

Split by both quantifier and subj

```{r rrdur3 }
res %>%
  filter(source == "rrdur_split_quant_typic_r1.csv") %>%
  select(-source) %>%
  mutate(condition = case_when(
           condition == "EEN_atypical" ~ "een subj mis",
           condition == "EEN_typical" ~ "een subj match",
           condition == "GEEN_typical" ~ "geen subj match",
           condition == "GEEN_atypical" ~ "geen subj mis"),
         region = "region_1") %>%
  kable()
```

```{r rrdur3-plot, results = "markup" }

fit_split(dfs[1], "rrdur",
    split_by = "quant_typic",
    .priors = priors_binom
    ) %>%
    pluck("region_1") %>%
    list_rename("een subj mis" = "EEN_atypical",
                      "een subj match" = "EEN_typical",
                      "geen subj match" = "GEEN_typical",
                      "geen subj mis" = "GEEN_atypical") %>%
    map(make_plot)
```

```{r rrdur4 }
res %>%
  filter(source == "rrdur_split_quant_typic_r5.csv") %>%
  select(-source) %>%
  mutate(condition = case_when(
           condition == "EEN_atypical" ~ "een subj mis",
           condition == "EEN_typical" ~ "een subj match",
           condition == "GEEN_typical" ~ "geen subj match",
           condition == "GEEN_atypical" ~ "geen subj mis"),
         region = "region_5") %>%
  kable()
```

```{r rrdur4-plot, results = "markup" }
fit_split(dfs[5], "rrdur",
    split_by = "quant_typic",
    .priors = priors_binom
    ) %>%
    pluck("region_5") %>%
    list_rename("een subj mis" = "EEN_atypical",
                      "een subj match" = "EEN_typical",
                      "geen subj match" = "GEEN_typical",
                      "geen subj mis" = "GEEN_atypical") %>%
    map(make_plot)
```

## First pass regression path

There were problems with fitting the `rpdur` measure. So currently we don't have a model for that.

## First pass


```{r rstan_models }
stanm_pars <- c("alpha", "b_quant", "b_typic", "b_interf",
                "b_interf_quant", "b_interf_typic",
                "b_quant_typic", "b_interf_quant_typic",
                "sigma_e", "sigma_e_shift", "prob", "delta")

stan_betas <- c("b_quant", "b_typic", "b_interf",
                "b_interf_quant", "b_interf_typic",
                "b_quant_typic", "b_interf_quant_typic")

stanm_pars_split <- c("alpha", "b_typic", "b_interf",
                      "b_interf_typic", "sigma_e",
                      "sigma_e_shift", "prob", "delta")

stan_betas_split <- c("b_typic", "b_interf", "b_interf_typic")

new_labs <- c("alpha" = "intercept", "b_typic" = "subj",
              "b_interf" = "obj", "b_quant" = "quant",
              "b_interf_typic" = "subj x obj",
              "b_quant_typic" = "subj x quants",
              "b_interf_quant" = "obj x quants",
              "b_interf_quant_typic" = "subj x obj x quants",
              "prob" = "theta")

rstan_models_smr <- dir_ls(here("models"),
                           regexp =  "t?gdur_stan_region[5-9].rds") %>%
  map(readRDS) %>%
  map(~ summary(.,
                pars = stanm_pars,
                probs = c(0.025, 0.975)
                )$summary) %>%
  map(relabel_stan_sum) %>%
  map_dfr(as.data.frame, .id = "source") %>%
  mutate(source = path_file(source)) %>%
  rename(region = source)

```
First pass first gaze, `gdur`. Stan full model. Region 5 and the following ones (e.g. starting on critical).

```{r gdur }
rstan_models_smr %>%
  filter(grepl("^gdur", region)) %>%
  mutate(region = as.numeric(sub(".*region([1-9]).*",
                                 "\\1", region))) %>%
  kable()
```

Note low eff in region 8 for `sigma_e_shift` and `theta`. In addition the bad fit of that model can be seen doing a posterior predictive check:

```{r pp-check-gdur-r8, results = "markup" }

y <- read_csv(here("results/region8.csv")) %>%
  filter(gdur != 0) %>%
  pull(gdur)

ppc_dens_overlay(y,
                 rstan::extract(readRDS(here("models/gdur_stan_region8.rds")),
                         pars = "yrep")$yrep[1:200,]) +
  coord_cartesian(## ylim = c(0, 0.005),
    xlim = c(0, 1500))

```

A slightly better model is a simple lognormal model.

```{r lognormal-gdur-r8 }
readRDS(here("models/gdur_r8.rds")) %>%
  ps_rename() %>%
  kable()
```

Rhats for this model are better:

```{r rhat-gdur-r8, results = "markup", echo = TRUE}
rhat(readRDS(here("models/gdur_r8.rds")))[1:8]
```

But the fit is still not great.

```{r gdur-r8-ppc-brms }
readRDS(here("models/gdur_r8.rds")) %>%
  pp_check(nsamples = 100)
```

```{r pps_gdur, results = "markup" }
dir_ls(here("models"), regexp =  "[^t]gdur_stan_region[5,6,7,9].rds") %>%
  set_names( ~ sub(".*(region[1-9]).*", "gdur_\\1",.)) %>%
  map(readRDS) %>%
  map(as.array) %>%
  map(~ mcmc_intervals(., pars = stan_betas) +
        scale_y_discrete(labels = new_labs))
```

Posterior distribution plot region 8

```{r plot-gdur-r8 }

readRDS(here("models/gdur_r8.rds")) %>%
  make_plot()

```

### Split models

NB: Rhats in some of these are really bad. Split models should be only treated as an interpretative help.

```{r gdur-split }

dir_ls(here("models"),
       regexp =  "[^t]gdur_g?een_stan_region[5,6,9].rds",
       perl = TRUE) %>%
  set_names( ~ sub(".*(gdur_g?een_)stan_(region[1-9]).*", "\\1\\2",.)) %>%
  map(readRDS) %>%
  .[order(sub(".*([1-9])", "\\1", names(.)))] %>%
  map(~ summary(.,
                pars = stanm_pars_split,
                probs = c(0.025, 0.975)
                )$summary) %>%
  map(relabel_stan_sum) %>%
  map_dfr(as.data.frame, .id = "condition") %>%
  kable(digits = 5)
```

```{r gdur-plots-split, results = "markup" }
dir_ls(here("models"),
       regexp =  "[^t]gdur_g?een_stan_region[5,6,9].rds",
       perl = TRUE) %>%
  set_names( ~ sub(".*(gdur.*[1-9]).*", "\\1",.)) %>%
  .[order(sub(".*([1-9])", "\\1", names(.)))] %>%
  map(readRDS) %>%
  map(as.array) %>%
  map(~ mcmc_intervals(., pars = stan_betas_split) +
        scale_y_discrete(labels = new_labs))
```

## Right bounded

Aka first pass total gaze, `tgdur`. Stan full models. Note that region 5 fit badly.

```{r tgdur }
rstan_models_smr %>%
  filter(grepl("^tgdur", region)) %>%
  mutate(region = sub(".*region([1-9]).*", "\\1", region)) %>%
  kable()
```

`tgdur` region 5 simple lognormal model

```{r tgdur-r5 }
readRDS(here("models/tgdur_r5.rds")) %>%
  ps_rename() %>%
  kable()
```

```{r tgdur-pps-r5 }
readRDS(here("models/tgdur_r5.rds")) %>%
  make_plot()
```

```{r pps_tgdur, results = "markup" }
dir_ls(here("models"), regexp =  "tgdur_stan_region[6-9].rds") %>%
  set_names( ~ sub(".*(region[1-9]).*", "tgdur_\\1", .)) %>%
  map(readRDS) %>%
  map(as.array) %>%
  map(~ mcmc_intervals(., pars = stan_betas) +
        scale_y_discrete(labels = new_labs))
```

### Split models

```{r tgdur-split }
dir_ls(here("models"),
       regexp =  "tgdur_g?een_stan_region[6-9].rds",
       perl = TRUE) %>%
  set_names( ~ sub(".*(tgdur_g?een_)stan_(region[1-9]).*", "\\1\\2",.)) %>%
  map(readRDS) %>%
  .[order(sub(".*([1-9])", "\\1", names(.)))] %>%
  map(~ summary(.,
                pars = stanm_pars_split,
                probs = c(0.025, 0.975)
                )$summary) %>%
  map(relabel_stan_sum) %>%
  map_dfr(as.data.frame, .id = "condition") %>%
  kable(digits = 5)
```

```{r tgdur-split-plots, results = "markup" }
dir_ls(here("models"),
       regexp =  "tgdur_g?een_stan_region[6-9].rds",
       perl = TRUE) %>%
  set_names( ~ sub(".*(tgdur.*[1-9]).*", "\\1",.)) %>%
  .[order(sub(".*([1-9])", "\\1", names(.)))] %>%
  map(readRDS) %>%
  map(as.array) %>%
  map(~ mcmc_intervals(., pars = stan_betas_split) +
        scale_y_discrete(labels = new_labs))
```

## Regressions

Probability of regression, `abs(gbck - 2)`. Bernoulli likelihood with logistic link, results on the logistic scale.
Full models.

```{r gbck }
res %>%
  filter(source == "gbck_full_models.csv") %>%
  select(-source, -quant) %>%
  kable()
```

```{r pps_gbck, results = "markup" }
post_plots("gbck", dfs, .return = "full_models")
post_plots("gbck", dfs, make_plot_func = pp_check, .return = "full_models")
```

### Split models

Models on data split per quantifier.

```{r gbck_2 }
res %>%
  filter(source == "gbck_split_models.csv") %>%
  select(-source) %>%
  kable()
```

```{r pps_gbck_2, results = "markup" }
post_plots("gbck", dfs, .return = "split_models")
post_plots("gbck", dfs, make_plot_func = pp_check, .return = "split_models")
```


### Further split models

Split by both quantifier and subj

```{r tot_spliter }
res %>%
  filter(source == "gbck_split_quant_typic_r6.csv") %>%
  select(-source) %>%
  mutate(condition = case_when(
           condition == "EEN_atypical" ~ "een subj mis",
           condition == "EEN_typical" ~ "een subj match",
           condition == "GEEN_typical" ~ "geen subj match",
           condition == "GEEN_atypical" ~ "geen subj mis"),
         region = "region_6") %>%
  kable()
```

```{r plots_tot_split2, results = "markup" }

fit_split(dfs[6], "gbck",
    split_by = "quant_typic",
    .priors = priors_binom,
    remove_zeros = FALSE
    ) %>%
    pluck("region_6") %>%
    list_rename("een subj mis" = "EEN_atypical",
                      "een subj match" = "EEN_typical",
                      "geen subj match" = "GEEN_typical",
                      "geen subj mis" = "GEEN_atypical") %>%
    map(make_plot)
```


## Re-readings

`rr`. probability of re-reading  
Bernoulli likelihood with logistic link, results on the logistic scale.

```{r rr }
res %>%
  filter(source == "rr_full_models.csv") %>%
  select(-source, -quant) %>%
  kable()
```

```{r pps_rr, results = "markup" }
post_plots("rr", dfs, .return = "full_models")
post_plots("rr", dfs, make_plot_func = pp_check, .return = "full_models")
```

### Split models

Models on data split per quantifier. 

```{r rr_2 }
res %>%
  filter(source == "rr_split_models.csv") %>%
  select(-source) %>%
  kable()
```

```{r pps_rr_2, results = "markup" }
post_plots("rr", dfs, .return = "split_models")
post_plots("rr", dfs, make_plot_func = pp_check, .return = "split_models")
```
