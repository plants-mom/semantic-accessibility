---
title: eye-tracking models
author: jw
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r cod1, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE}

here::i_am("doc/models_summary.Rmd")

library(here)
library(knitr)
library(dplyr)
library(purrr)
library(readr)
library(fs)

source(here("src/models_summary.R"))
source(here("src/models.R"))

dfs <- list.files(here("results"), pattern = "region[0-9].csv") %>%
  map(~ read_csv(here("results", .)))

opts_chunk$set(echo = FALSE, results = "asis", fig.path = here("figs/"), cache = TRUE)

res <- dir_ls(here("results"), regexp =  "[a-z]+_(full)|(split)_[a-z_86]+.csv") %>%
  map_dfr(read_csv, .id = "source") %>%
  mutate(source = path_file(source))
```

> â€˜The professor has [a/no] [son/daughter]. The past few years, [he/she] unfortunately had to work during all the holidays.

there are 8 means in the experiment (quantifier, subject, object conditions):
```
a) EEN,  MATCH, MATCH (typical,  int)   -- prof ... a  son      ... he
b) EEN,  MATCH, MIS   (typical,  noint) -- prof ... a  daughter ... he
c) EEN,  MIS,   MATCH (atypical, int)   -- prof ... a  daughter ... she
d) EEN,  MIS,   MIS   (atypical, noint) -- prof ... a  son      ... she
e) GEEN, MATCH, MATCH (typical,  int)   -- prof ... no son      ... he
f) GEEN, MATCH, MIS   (typical,  noint) -- prof ... no daughter ... he
g) GEEN, MIS,   MATCH (atypical, int)   -- prof ... no daughter ... she
h) GEEN, MIS,   MIS   (atypical, noint) -- prof ... no son      ... she
```

Contrasts:

```{r coding, eval = FALSE, include = TRUE, echo = TRUE, results = "markup"}

mutate(
    cond = case_when(
      quan_cond == "EEN" & subj_cond == "MATCH" & obj_cond == "MATCH" ~ "a",
      quan_cond == "EEN" & subj_cond == "MATCH" & obj_cond == "MIS" ~ "b",
      quan_cond == "EEN" & subj_cond == "MIS" & obj_cond == "MATCH" ~ "c",
      quan_cond == "EEN" & subj_cond == "MIS" & obj_cond == "MIS" ~ "d",
      quan_cond == "GEEN" & subj_cond == "MATCH" & obj_cond == "MATCH" ~ "e",
      quan_cond == "GEEN" & subj_cond == "MATCH" & obj_cond == "MIS" ~ "f",
      quan_cond == "GEEN" & subj_cond == "MIS" & obj_cond == "MATCH" ~ "g",
      quan_cond == "GEEN" & subj_cond == "MIS" & obj_cond == "MIS" ~ "h"
    ),
    quants = ifelse(quan_cond == "EEN", -1, 1),
    typic = ifelse(cond %in% c("a", "b", "e", "f"), 1, -1),
    interf = ifelse(cond %in% c("a", "c", "e", "g"), 1, -1),
```

All regions as coded in the file. On the plots the thick line signifies the 0.95 probability interval, the thin line probability of 1.


## Total fixation duration

Total fixations, all regions.

Full models.

```{r tot }
res %>%
  filter(source == "totfixdur_full_models.csv") %>%
  select(-source, -quant) %>%
  kable()
```

```{r pps1, results = "markup" }
post_plots("totfixdur", dfs, .return = "full_models")
post_plots("totfixdur", dfs, make_plot_func = pp_check, .return = "full_models")
```

### Split models

Models on data split per quantifier.

```{r tot2 }
res %>%
  filter(source == "totfixdur_split_models.csv") %>%
  select(-source) %>%
  kable()
```

```{r pps2, results = "markup" }
post_plots("totfixdur", dfs, .return = "split_models")
## post_plots("totfixdur", dfs, make_plot_func = pp_check)$split_models
```

### Further splitted models

Splitted by both quantifier and subj

```{r tot_split }
res %>%
  filter(source == "totfixdur_split_quant_typic_r8.csv") %>%
  select(-source) %>%
  mutate(condition = case_when(
           condition == "EEN_atypical" ~ "een subj mis",
           condition == "EEN_typical" ~ "een subj match",
           condition == "GEEN_typical" ~ "geen subj match",
           condition == "GEEN_atypical" ~ "geen subj mis"),
         region = "region_8") %>%
  kable()
```

```{r plots_tot_split, results = "markup" }

fit_split(dfs[7], "totfixdur",
          split_by = "quant_typic",
          .priors = priors
          ) %>%
  .[[1]] %>%
  list_rename("een subj mis" = "EEN_atypical",
              "een subj match" = "EEN_typical",
              "geen subj match" = "GEEN_typical",
              "geen subj mis" = "GEEN_atypical") %>%
  map(make_plot)
```

## Re-reading duration

Data was excluded when the subj did not re-read the region.

Full models.

```{r rrdur }
res %>%
  filter(source == "rrdur_full_models.csv") %>%
  select(-source, -quant) %>%
  kable()
```

```{r pps_rrdur, results = "markup" }
post_plots("rrdur", dfs, .return = "full_models")
post_plots("rrdur", dfs, make_plot_func = pp_check, .return = "full_models")
```

### Split models

Models on data split per quantifier.

```{r rrdur2 }
res %>%
  filter(source == "rrdur_split_models.csv") %>%
  select(-source) %>%
  kable()
```


```{r pps_rrdur2, results = "markup" }
post_plots("rrdur", dfs, .return = "split_models")
post_plots("rrdur", dfs, make_plot_func = pp_check, .return = "split_models")
```

## First pass regression path

There were problems with fitting the `rpdur` measure. So currently we don't have a model for that.

## First pass first gaze

```{r rstan_models }
stanm_pars <- c("alpha", "b_quant", "b_typic", "b_interf",
                "b_interf_quant", "b_interf_typic",
                "b_quant_typic", "b_interf_quant_typic",
                "sigma_e", "sigma_e_shift", "prob", "delta")

stan_betas <- c("b_quant", "b_typic", "b_interf",
                "b_interf_quant", "b_interf_typic",
                "b_quant_typic", "b_interf_quant_typic")

new_labs <- c("alpha" = "intercept", "b_typic" = "subj",
              "b_interf" = "obj", "b_quant" = "quant",
              "b_interf_typic" = "subj x obj",
              "b_quant_typic" = "subj x quants",
              "b_interf_quant" = "obj x quants",
              "b_interf_quant_typic" = "subj x obj x quants",
              "prob" = "theta")

rstan_models <- c(gdur_stan = "gdur_stan_r6.rds", tgdur_stan = "tgdur_stan_r6.rds") %>%
    map(~ readRDS(here("models", .))) %>%
    map(~ summary(.,
      pars = stanm_pars,
      probs = c(0.025, 0.975)
    )$summary) %>%
    map(relabel_stan_sum)

```

`gdur`. Stan full model. Only on regions 6-7.

```{r gdur }
rstan_models %>%
  pluck("gdur_stan") %>%
  kable()
```

```{r pps_gdur, results = "markup" }
readRDS(here("models/gdur_stan_r6.rds")) %>%
  as.array() %>%
  mcmc_intervals(pars = stan_betas) +
  scale_y_discrete(labels = new_labs)
  
```


## First pass total gaze

`tgdur`. Stan full model. Only on regions 6-7.

```{r tgdur }
rstan_models %>%
  pluck("tgdur_stan") %>%
  kable()
```

```{r pps_tgdur, results = "markup" }
readRDS(here("models/tgdur_stan_r6.rds")) %>%
  as.array() %>%
  mcmc_intervals(pars = stan_betas) +
  scale_y_discrete(labels = new_labs)
```

## Regressions

Probability of regression, `abs(gbck - 2)`. Bernoulli likelihood with logistic link, results on the logistic scale.
Full models.

```{r gbck }
res %>%
  filter(source == "gbck_full_models.csv") %>%
  select(-source, -quant) %>%
  kable()
```

```{r pps_gbck, results = "markup" }
post_plots("gbck", dfs, .return = "full_models")
post_plots("gbck", dfs, make_plot_func = pp_check, .return = "full_models")
```

### Split models

Models on data split per quantifier.

```{r gbck_2 }
res %>%
  filter(source == "gbck_split_models.csv") %>%
  select(-source) %>%
  kable()
```

```{r pps_gbck_2, results = "markup" }
post_plots("gbck", dfs)
post_plots("gbck", dfs, make_plot_func = pp_check)
```


### Further splitted models

Splitted by both quantifier and subj

```{r tot_spliter }
res %>%
  filter(source == "gbck_split_quant_typic_r6.csv") %>%
  select(-source) %>%
  mutate(condition = case_when(
           condition == "EEN_atypical" ~ "een subj mis",
           condition == "EEN_typical" ~ "een subj match",
           condition == "GEEN_typical" ~ "geen subj match",
           condition == "GEEN_atypical" ~ "geen subj mis"),
         region = "region_6") %>%
  kable()
```

```{r plots_tot_split2, results = "markup" }

fit_split(dfs[6], "gbck",
    split_by = "quant_typic",
    .priors = priors_binom,
    remove_zeros = FALSE
    ) %>%
    pluck("region_6") %>%
    list_rename("een subj mis" = "EEN_atypical",
                      "een subj match" = "EEN_typical",
                      "geen subj match" = "GEEN_typical",
                      "geen subj mis" = "GEEN_atypical") %>%
    map(make_plot)
```


## Re-readings

`rr`. probability of re-reading  
Bernoulli likelihood with logistic link, results on the logistic scale.

```{r rr }
res %>%
  filter(source == "rr_full_models.csv") %>%
  select(-source, -quant) %>%
  kable()
```

```{r pps_rr, results = "markup" }
post_plots("rr", dfs, .return = "full_models")
post_plots("rr", dfs, make_plot_func = pp_check, .return = "full_models")
```

### Split models

Models on data split per quantifier. 

```{r rr_2 }
res %>%
  filter(source == "rr_split_models.csv") %>%
  select(-source) %>%
  kable()
```

```{r pps_rr_2, results = "markup" }
post_plots("rr", dfs)
post_plots("rr", dfs, make_plot_func = pp_check)
```
